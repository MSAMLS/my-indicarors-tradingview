//@version=6
indicator("ICT Kill Zones - Extended", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=200)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

showLondonKZ = input.bool(true, "Show London Open KZ", group="ğŸ¯ Kill Zones")
showNYAM_KZ = input.bool(true, "Show NY AM KZ â­", group="ğŸ¯ Kill Zones")
showLonCloseKZ = input.bool(true, "Show London Close KZ", group="ğŸ¯ Kill Zones")
showNYLunch_KZ = input.bool(true, "Show NY Lunch", group="ğŸ¯ Kill Zones")
showNYPM_KZ = input.bool(true, "Show NY PM KZ", group="ğŸ¯ Kill Zones")
kzDaysBack = input.int(5, "Session Drawing Limit", minval=1, maxval=20, group="ğŸ¯ Kill Zones")

showKZHighLow = input.bool(true, "Show KZ High/Low Lines", group="ğŸ“ˆ KZ Levels")
showKZBrokenAsDashed = input.bool(true, "Show Broken Part as Dashed", group="ğŸ“ˆ KZ Levels")
hideKZBrokenPart = input.bool(false, "Hide Broken Part Completely", group="ğŸ“ˆ KZ Levels")
kzBrokenLineStyle = input.string("Dashed", "Broken Line Style", options=["Solid", "Dotted", "Dashed"], group="ğŸ“ˆ KZ Levels")
showKZPriceOnLabel = input.bool(true, "Show Price on Labels", group="ğŸ“ˆ KZ Levels")
kzLabelOffsetBars = input.int(5, "Label Offset (bars)", minval=0, maxval=50, group="ğŸ“ˆ KZ Levels")

// Colors
londonKZName = input.string("London Open", "Name", inline="LKZ", group="ğŸ¨ London Open KZ")
londonKZColor = input.color(color.new(#2196F3, 92), "Box", inline="LKZ", group="ğŸ¨ London Open KZ")
londonKZLineColor = input.color(#2196F3, "Line", inline="LKZ", group="ğŸ¨ London Open KZ")

nyamKZName = input.string("NY AM â­", "Name", inline="NYAM", group="ğŸ¨ NY AM KZ")
nyamKZColor = input.color(color.new(#00C853, 92), "Box", inline="NYAM", group="ğŸ¨ NY AM KZ")
nyamKZLineColor = input.color(#00C853, "Line", inline="NYAM", group="ğŸ¨ NY AM KZ")

lonCloseKZName = input.string("London Close", "Name", inline="LCKZ", group="ğŸ¨ London Close KZ")
lonCloseKZColor = input.color(color.new(#f44336, 92), "Box", inline="LCKZ", group="ğŸ¨ London Close KZ")
lonCloseKZLineColor = input.color(#f44336, "Line", inline="LCKZ", group="ğŸ¨ London Close KZ")

lunchKZName = input.string("NY Lunch", "Name", inline="LUNCH", group="ğŸ¨ NY Lunch")
lunchKZColor = input.color(color.new(#FF9800, 92), "Box", inline="LUNCH", group="ğŸ¨ NY Lunch")
lunchKZLineColor = input.color(#FF9800, "Line", inline="LUNCH", group="ğŸ¨ NY Lunch")

nypmKZName = input.string("NY PM", "Name", inline="NYPM", group="ğŸ¨ NY PM KZ")
nypmKZColor = input.color(color.new(#9C27B0, 92), "Box", inline="NYPM", group="ğŸ¨ NY PM KZ")
nypmKZLineColor = input.color(#9C27B0, "Line", inline="NYPM", group="ğŸ¨ NY PM KZ")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TYPE & ARRAYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

type KZData
    box kzBox
    line highLineSolid
    line lowLineSolid
    line highLineBroken
    line lowLineBroken
    label highLabel
    label lowLabel
    float highPrice
    float lowPrice
    int startBar
    int endBar
    int highBreakBar
    int lowBreakBar
    bool highBroken
    bool lowBroken
    int dayNumber

var array<KZData> londonKZs = array.new<KZData>()
var array<KZData> nyamKZs = array.new<KZData>()
var array<KZData> lonCloseKZs = array.new<KZData>()
var array<KZData> lunchKZs = array.new<KZData>()
var array<KZData> nypmKZs = array.new<KZData>()

var int currentKZDay = 0
// Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¼ĞµĞ½Ñ‹ Ğ´Ğ½Ñ Ğ´Ğ»Ñ v6
if not na(ta.change(time("D", "America/New_York")))
    currentKZDay += 1

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

isSession(sess) => not na(time(timeframe.period, sess, "America/New_York"))

getLineStyle(styleStr) =>
    styleStr == "Dotted" ? line.style_dotted : styleStr == "Dashed" ? line.style_dashed : line.style_solid

deleteOldest(array<KZData> kzs) =>
    if array.size(kzs) > 0
        old = array.shift(kzs)
        box.delete(old.kzBox), line.delete(old.highLineSolid), line.delete(old.lowLineSolid)
        line.delete(old.highLineBroken), line.delete(old.lowLineBroken)
        label.delete(old.highLabel), label.delete(old.lowLabel)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

processKZ(bool show, string sess, string name, color bgCol, color lineCol, array<KZData> arr, float kHigh, float kLow, int kStart) =>
    bool inSess = isSession(sess)
    float h = kHigh
    float l = kLow
    int s = kStart

    if inSess and not inSess[1]
        // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€ÑƒÑ ÑĞµÑÑĞ¸Ñ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ñ‚Ğ¾Ğ³Ğ¾ Ğ¶Ğµ Ñ‚Ğ¸Ğ¿Ğ°
        if show and array.size(arr) >= kzDaysBack
            deleteOldest(arr)
        h := high
        l := low
        s := bar_index
    else if inSess
        h := math.max(h, high)
        l := math.min(l, low)

    if show and not inSess and inSess[1]
        // bar_index - 1 Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ½ĞµÑ† Ğ·Ğ¾Ğ½Ñ‹ Ğ½Ğ° ĞŸĞ Ğ•Ğ”Ğ«Ğ”Ğ£Ğ©Ğ•Ğœ Ğ±Ğ°Ñ€Ğµ (Ñ€Ğ¾Ğ²Ğ½Ğ¾ Ğ² 16:00 Ğ´Ğ»Ñ M15)
        endB = bar_index - 1
        kzBox = box.new(s, h, endB, l, border_color=lineCol, bgcolor=bgCol, border_width=1, text=name, text_color=lineCol, text_size=size.normal, text_halign=text.align_center, text_valign=text.align_center)
        highLnSolid = line(na), lowLnSolid = line(na), highLnBroken = line(na), lowLnBroken = line(na), highLbl = label(na), lowLbl = label(na)

        if showKZHighLow
            highLnSolid := line.new(endB, h, endB, h, color=lineCol, width=2, style=line.style_solid)
            lowLnSolid := line.new(endB, l, endB, l, color=lineCol, width=2, style=line.style_solid)
            labelX = endB + kzLabelOffsetBars
            pStrH = showKZPriceOnLabel ? " " + str.tostring(h, "#.####") : ""
            pStrL = showKZPriceOnLabel ? " " + str.tostring(l, "#.####") : ""
            highLbl := label.new(labelX, h, name + " H" + pStrH, style=label.style_label_left, color=lineCol, textcolor=color.white, size=size.small)
            lowLbl := label.new(labelX, l, name + " L" + pStrL, style=label.style_label_left, color=lineCol, textcolor=color.white, size=size.small)

        array.push(arr, KZData.new(kzBox, highLnSolid, lowLnSolid, highLnBroken, lowLnBroken, highLbl, lowLbl, h, l, s, endB, na, na, false, false, currentKZDay))
    [h, l, s]

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹
var float lnH = na, var float lnL = na, var int lnS = na
var float nyH = na, var float nyL = na, var int nyS = na
var float lcH = na, var float lcL = na, var int lcS = na
var float luH = na, var float luL = na, var int luS = na
var float pmH = na, var float pmL = na, var int pmS = na

[h1, l1, s1] = processKZ(showLondonKZ, "0200-0500:23456", londonKZName, londonKZColor, londonKZLineColor, londonKZs, lnH, lnL, lnS)
lnH := h1, lnL := l1, lnS := s1

[h2, l2, s2] = processKZ(showNYAM_KZ, "0800-1100:23456", nyamKZName, nyamKZColor, nyamKZLineColor, nyamKZs, nyH, nyL, nyS)
nyH := h2, nyL := l2, nyS := s2

[h3, l3, s3] = processKZ(showLonCloseKZ, "1000-1200:23456", lonCloseKZName, lonCloseKZColor, lonCloseKZLineColor, lonCloseKZs, lcH, lcL, lcS)
lcH := h3, lcL := l3, lcS := s3

[h4, l4, s4] = processKZ(showNYLunch_KZ, "1130-1300:23456", lunchKZName, lunchKZColor, lunchKZLineColor, lunchKZs, luH, luL, luS)
luH := h4, luL := l4, luS := s4

[h5, l5, s5] = processKZ(showNYPM_KZ, "1300-1600:23456", nypmKZName, nypmKZColor, nypmKZLineColor, nypmKZs, pmH, pmL, pmS)
pmH := h5, pmL := l5, pmS := s5

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATE LINES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

updateKZLines(array<KZData> kzs, col) =>
    if showKZHighLow and array.size(kzs) > 0
        for i = 0 to array.size(kzs) - 1
            kz = array.get(kzs, i)
            if not kz.highBroken and (high > kz.highPrice or low < kz.highPrice)
                if low <= kz.highPrice and high >= kz.highPrice
                    kz.highBroken := true, kz.highBreakBar := bar_index
            if not kz.lowBroken and (high > kz.lowPrice or low < kz.lowPrice)
                if low <= kz.lowPrice and high >= kz.lowPrice
                    kz.lowBroken := true, kz.lowBreakBar := bar_index

            if not kz.highBroken
                line.set_x2(kz.highLineSolid, bar_index)
                if not na(kz.highLabel)
                    label.set_x(kz.highLabel, bar_index + kzLabelOffsetBars)
            else
                if hideKZBrokenPart
                    line.set_x2(kz.highLineSolid, kz.highBreakBar)
                    if not na(kz.highLabel)
                        label.set_x(kz.highLabel, kz.highBreakBar), label.set_style(kz.highLabel, label.style_label_down)
                else
                    if showKZBrokenAsDashed
                        line.set_x2(kz.highLineSolid, kz.highBreakBar)
                        if na(kz.highLineBroken)
                            kz.highLineBroken := line.new(kz.highBreakBar, kz.highPrice, bar_index, kz.highPrice, color=col, width=2, style=getLineStyle(kzBrokenLineStyle))
                        else
                            line.set_x2(kz.highLineBroken, bar_index)
                    else
                        line.set_x2(kz.highLineSolid, bar_index)
                    if not na(kz.highLabel)
                        label.set_x(kz.highLabel, bar_index + kzLabelOffsetBars)

            if not kz.lowBroken
                line.set_x2(kz.lowLineSolid, bar_index)
                if not na(kz.lowLabel)
                    label.set_x(kz.lowLabel, bar_index + kzLabelOffsetBars)
            else
                if hideKZBrokenPart
                    line.set_x2(kz.lowLineSolid, kz.lowBreakBar)
                    if not na(kz.lowLabel)
                        label.set_x(kz.lowLabel, kz.lowBreakBar), label.set_style(kz.lowLabel, label.style_label_up)
                else
                    if showKZBrokenAsDashed
                        line.set_x2(kz.lowLineSolid, kz.lowBreakBar)
                        if na(kz.lowLineBroken)
                            kz.lowLineBroken := line.new(kz.lowBreakBar, kz.lowPrice, bar_index, kz.lowPrice, color=col, width=2, style=getLineStyle(kzBrokenLineStyle))
                        else
                            line.set_x2(kz.lowLineBroken, bar_index)
                    else
                        line.set_x2(kz.lowLineSolid, bar_index)
                    if not na(kz.lowLabel)
                        label.set_x(kz.lowLabel, bar_index + kzLabelOffsetBars)

updateKZLines(londonKZs, londonKZLineColor)
updateKZLines(nyamKZs, nyamKZLineColor)
updateKZLines(lonCloseKZs, lonCloseKZLineColor)
updateKZLines(lunchKZs, lunchKZLineColor)
updateKZLines(nypmKZs, nypmKZLineColor)
